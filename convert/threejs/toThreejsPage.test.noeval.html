<html><head><title>JSxCAD Viewer</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<style>
body {
  color: #cccccc;
  font-family: Monospace;
  font-size: 13px;
  text-align: left;
  background-color: #050505;
  margin: 0px;
  overflow: hidden;
}

.dg { position: absolute; top: 2px; left: 2px }


</style>
<link href="https://codemirror.net/lib/codemirror.css" rel="stylesheet"></head><body id="body"><!-- CodeMirror -->




<!-- ThreeJS -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/87/three.min.js"></script>
<script type="text/javascript" src="https://cdn.rawgit.com/mrdoob/stats.js/master/build/stats.min.js"></script>
<script type="text/javascript" src="https://cdn.rawgit.com/mrdoob/three.js/master/examples/js/controls/TrackballControls.js"></script>
<script type="text/javascript" src="https://cdn.rawgit.com/dataarts/dat.gui/master/build/dat.gui.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/ami.js//0.0.20/ami.min.js"></script>
<!-- FileSaver -->
<script type="module">

import { readFile, watchFile, watchFileCreation, writeFile } from 'https://unpkg.com/@jsxcad/sys@0.0.56?module';
import { toThreejsGeometry } from 'https://unpkg.com/@jsxcad/convert-threejs@0.0.56?module';

let pages = [];

const tag = (data, tags) => {
  data.tags = tags;
  return data;
}

const addPage = (element) => {
  element.style.display = 'none';
  document.getElementById("body").appendChild(element);
  pages.push(element);
}

const nextPage = () => {
  pages[0].style.display = 'none';
  pages.push(pages.shift());
  pages[0].style.display = 'block';
}

const lastPage = () => {
  pages[0].style.display = 'none';
  pages.unshift(pages.pop());
  pages[0].style.display = 'block';
}

const addDisplay = (path, { cameraPosition = [0, 0, 16], geometry} = {}) => {
  // Add a new display when we see a new file written.
  let datasets = [];
  let camera;
  let controls;
  let scene;
  let renderer;
  let stats;
  let mesh;
  let gui;
  let downloadButton;

  const toName = (geometry) => {
    if (geometry.tags !== undefined && geometry.tags.length >= 1) {
      return geometry.tags[0];
    }
  }

  const updateDatasets = (geometry) => {
    // Delete any previous dataset in the window.
    for (const { controller, mesh } of datasets) {
      if (controller) {
        gui.remove(controller);
      }
      scene.remove(mesh);
    }
    // Build new datasets from the written data, and display them.
    datasets = [];

    const walk = (geometry) => {
      if (geometry.assembly) {
        geometry.assembly.forEach(walk);
      } else if (geometry.threejsSegments) {
        const segments = geometry.threejsSegments; // pathsToThreejsSegments(geometry.paths);
        const dataset = {};
        const threejsGeometry = new THREE.Geometry();
        const material = new THREE.LineBasicMaterial({ color: 0xff0000 });
        for (const [[aX, aY, aZ], [bX, bY, bZ]] of segments) {
          threejsGeometry.vertices.push(new THREE.Vector3(aX, aY, aZ), new THREE.Vector3(bX, bY, bZ));
        }
        dataset.mesh = new THREE.LineSegments(threejsGeometry, material);
        dataset.name = toName(geometry);
        scene.add(dataset.mesh);
        datasets.push(dataset);
      } else if (geometry.threejsSolid) {
        const { positions, normals } = geometry.threejsSolid; // solidToThreejsSolid(geometry.solid);
        const dataset = {};
        const threejsGeometry = new THREE.BufferGeometry();
        threejsGeometry.addAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
        threejsGeometry.addAttribute('normal', new THREE.Float32BufferAttribute(normals, 3));
        const material = new THREE.MeshNormalMaterial();
        dataset.mesh = new THREE.Mesh(threejsGeometry, material);
        dataset.name = toName(geometry);
        scene.add(dataset.mesh);
        datasets.push(dataset);
      } else if (geometry.threejsSurface) {
        const { positions, normals } = geometry.threejsSurface; // surfaceToThreejsSurface(geometry.z0Surface);
        const dataset = {};
        const threejsGeometry = new THREE.BufferGeometry();
        threejsGeometry.addAttribute('position', new THREE.Float32BufferAttribute( positions, 3));
        threejsGeometry.addAttribute('normal', new THREE.Float32BufferAttribute( normals, 3));
        const material = new THREE.MeshNormalMaterial();
        dataset.mesh = new THREE.Mesh(threejsGeometry, material);
        dataset.name = toName(geometry);
        scene.add(dataset.mesh);
        datasets.push(dataset);
      }
    };

    walk(geometry);

    const controllers = {};
    for (const dataset of datasets) {
      if (dataset.name === undefined) { continue; }
      let controller = controllers[dataset.name]
      if (controller === undefined) {
        controller = gui.add({ visible: true }, 'visible').name(`Show ${dataset.name}?`);
        controllers[dataset.name] = controller;
      }
      controller.listen().onChange((value) => { dataset.mesh.visible = value; });
    }
  };

  if (typeof api.toThreejsGeometry !== 'undefined') {
    watchFile(path, (file, data) => {
                      if (data !== undefined) {
                        updateDatasets(api.toThreejsGeometry(data));
                      }
                     });
  }

  init();
  animate();
  function init() {
    //
    camera = new THREE.PerspectiveCamera( 27, window.innerWidth / window.innerHeight, 1, 3500 );
    [camera.position.x, camera.position.y, camera.position.z] = cameraPosition;
    //
    controls = new THREE.TrackballControls(camera);
    controls.rotateSpeed = 4.0;
    controls.zoomSpeed = 4.0;
    controls.panSpeed = 2.0;
    controls.noZoom = false;
    controls.noPan = false;
    controls.staticMoving = true;
    controls.dynamicDampingFactor = 0.1;
    controls.keys = [65, 83, 68];
    controls.addEventListener('change', render);
    //
    scene = new THREE.Scene();
    scene.background = new THREE.Color( 0x050505 );
    scene.add(camera);
    //
    var ambientLight = new THREE.AmbientLight( 0x222222 );
    scene.add( ambientLight );
    var light = new THREE.DirectionalLight( 0xffffff, 1 );
    light.position.set( 1, 1, 1 );
    camera.add(light);
    renderer = new THREE.WebGLRenderer( { antialias: true } );
    renderer.setPixelRatio( window.devicePixelRatio );
    renderer.setSize( window.innerWidth, window.innerHeight);
    // TODO: Something more clever than this.
    const viewerElement = document.createElement("div");
    viewerElement.id = `viewer:${path}`;
    viewerElement.appendChild(renderer.domElement);
    gui = new dat.GUI({ autoPlace: false });
    viewerElement.appendChild(gui.domElement);
    
    viewerElement.appendChild(makeDownloadButton());
    
    addPage(viewerElement);
    window.addEventListener( 'resize', onWindowResize, false );
  }
  function makeDownloadButton() {
    downloadButton = document.createElement("button");
    downloadButton.setAttribute("type", "button");
    downloadButton.appendChild(document.createTextNode("Download"));
    downloadButton.setAttribute("style", "position: absolute; top: 2px; right: 2px;");
    downloadButton.addEventListener("click", () => {
      const blob = new Blob([readFileSync(path)], {type: "text/plain;charset=utf-8"});
      saveAs(blob, path+'.stl');
    });
    return downloadButton;
  }
  function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    controls.handleResize();
    // renderer.setSize( window.innerWidth * 0.5, window.innerHeight * 0.5);
  }
  function animate() {
    requestAnimationFrame( animate );
    render();
    controls.update();
    // stats.update();
  }
  function render() {
    renderer.render( scene, camera );
  }

  if (geometry) {
    updateDatasets(geometry);
  }
};

if (typeof watchFileCreation !== 'undefined') {
  watchFileCreation(({ path }) => addDisplay(path));
}


const runApp = () => {
  writeFile("default", () => {}, {"assembly":[{"threejsSegments":[[[-1.5,-2.59809,0],[3,0,0]],[[3,0,0],[-1.5,2.59809,0]],[[-1.5,2.59809,0],[-1.5,-2.59809,0]]],"tags":["paths"],"isThreejsGeometry":true},{"threejsSolid":{"normals":[0.9341721347384871,-0.35682267679918794,0,0.9341721347384871,-0.35682267679918794,0,0.9341721347384871,-0.35682267679918794,0,0.9341721347384871,0.35682267679918794,0,0.9341721347384871,0.35682267679918794,0,0.9341721347384871,0.35682267679918794,0,0.35682267679918794,0,-0.9341721347384871,0.35682267679918794,0,-0.9341721347384871,0.35682267679918794,0,-0.9341721347384871,0.5773502691896258,0.5773502691896257,-0.5773502691896258,0.5773502691896258,0.5773502691896257,-0.5773502691896258,0.5773502691896258,0.5773502691896257,-0.5773502691896258,0.5773502691896258,-0.5773502691896257,-0.5773502691896258,0.5773502691896258,-0.5773502691896257,-0.5773502691896258,0.5773502691896258,-0.5773502691896257,-0.5773502691896258,0.35682267679918794,0,0.9341721347384871,0.35682267679918794,0,0.9341721347384871,0.35682267679918794,0,0.9341721347384871,0.5773502691896258,-0.5773502691896258,0.5773502691896257,0.5773502691896258,-0.5773502691896258,0.5773502691896257,0.5773502691896258,-0.5773502691896258,0.5773502691896257,0.5773502691896258,0.5773502691896257,0.5773502691896258,0.5773502691896258,0.5773502691896257,0.5773502691896258,0.5773502691896258,0.5773502691896257,0.5773502691896258,-0.9341721347384871,-0.35682267679918794,0,-0.9341721347384871,-0.35682267679918794,0,-0.9341721347384871,-0.35682267679918794,0,-0.9341721347384871,0.35682267679918794,0,-0.9341721347384871,0.35682267679918794,0,-0.9341721347384871,0.35682267679918794,0,-0.35682267679918794,0,0.9341721347384871,-0.35682267679918794,0,0.9341721347384871,-0.35682267679918794,0,0.9341721347384871,-0.5773502691896258,-0.5773502691896257,0.5773502691896258,-0.5773502691896258,-0.5773502691896257,0.5773502691896258,-0.5773502691896258,-0.5773502691896257,0.5773502691896258,-0.5773502691896257,0.5773502691896258,0.5773502691896258,-0.5773502691896257,0.5773502691896258,0.5773502691896258,-0.5773502691896257,0.5773502691896258,0.5773502691896258,-0.35682267679918794,0,-0.9341721347384871,-0.35682267679918794,0,-0.9341721347384871,-0.35682267679918794,0,-0.9341721347384871,-0.5773502691896258,0.5773502691896257,-0.5773502691896258,-0.5773502691896258,0.5773502691896257,-0.5773502691896258,-0.5773502691896258,0.5773502691896257,-0.5773502691896258,-0.5773502691896258,-0.5773502691896257,-0.5773502691896258,-0.5773502691896258,-0.5773502691896257,-0.5773502691896258,-0.5773502691896258,-0.5773502691896257,-0.5773502691896258,0,-0.9341721347384871,0.35682267679918794,0,-0.9341721347384871,0.35682267679918794,0,-0.9341721347384871,0.35682267679918794,0,0.9341721347384871,0.35682267679918794,0,0.9341721347384871,0.35682267679918794,0,0.9341721347384871,0.35682267679918794,0,0.9341721347384871,-0.35682267679918794,0,0.9341721347384871,-0.35682267679918794,0,0.9341721347384871,-0.35682267679918794,0,-0.9341721347384871,-0.35682267679918794,0,-0.9341721347384871,-0.35682267679918794,0,-0.9341721347384871,-0.35682267679918794],"positions":[0.85065,0,0.52573,0.52573,-0.85065,0,0.85065,0,-0.52573,0.85065,0,-0.52573,0.52573,0.85065,0,0.85065,0,0.52573,0.85065,0,-0.52573,0,-0.52573,-0.85065,0,0.52573,-0.85065,0.85065,0,-0.52573,0,0.52573,-0.85065,0.52573,0.85065,0,0.85065,0,-0.52573,0.52573,-0.85065,0,0,-0.52573,-0.85065,0,-0.52573,0.85065,0.85065,0,0.52573,0,0.52573,0.85065,0.52573,-0.85065,0,0.85065,0,0.52573,0,-0.52573,0.85065,0.85065,0,0.52573,0.52573,0.85065,0,0,0.52573,0.85065,-0.85065,0,-0.52573,-0.52573,-0.85065,0,-0.85065,0,0.52573,-0.85065,0,0.52573,-0.52573,0.85065,0,-0.85065,0,-0.52573,0,-0.52573,0.85065,0,0.52573,0.85065,-0.85065,0,0.52573,-0.85065,0,0.52573,-0.52573,-0.85065,0,0,-0.52573,0.85065,0,0.52573,0.85065,-0.52573,0.85065,0,-0.85065,0,0.52573,0,0.52573,-0.85065,0,-0.52573,-0.85065,-0.85065,0,-0.52573,-0.85065,0,-0.52573,-0.52573,0.85065,0,0,0.52573,-0.85065,-0.85065,0,-0.52573,0,-0.52573,-0.85065,-0.52573,-0.85065,0,0,-0.52573,0.85065,-0.52573,-0.85065,0,0.52573,-0.85065,0,0,0.52573,0.85065,0.52573,0.85065,0,-0.52573,0.85065,0,0,0.52573,-0.85065,-0.52573,0.85065,0,0.52573,0.85065,0,0,-0.52573,-0.85065,0.52573,-0.85065,0,-0.52573,-0.85065,0]},"tags":["solid"],"isThreejsGeometry":true},{"threejsSurface":{"normals":[0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1],"positions":[1,1,0,-1,1,0,-1,-1,0,-1,-1,0,-1,1,0,1,1,0,1,1,0,-1,-1,0,1,-1,0,1,-1,0,-1,-1,0,1,1,0]},"tags":["surface"],"isThreejsGeometry":true}],"isThreejsGeometry":true}).then(_ => nextPage());
}
document.addEventListener("DOMContentLoaded", runApp);
</script></body></html>