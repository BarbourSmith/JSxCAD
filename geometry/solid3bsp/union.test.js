const fromPolygons = require('./fromPolygons');
const mat4 = require('@jsxcad/math-mat4');
const test = require('ava');
const toPolygons = require('./toPolygons');
const transform = require('./transform');
const union = require('./union');

const cubePolygons = [[[-1, -1, -1], [-1, -1, 1], [-1, 1, 1], [-1, 1, -1]],
                      [[1, -1, -1], [1, 1, -1], [1, 1, 1], [1, -1, 1]],
                      [[-1, -1, -1], [1, -1, -1], [1, -1, 1], [-1, -1, 1]],
                      [[-1, 1, -1], [-1, 1, 1], [1, 1, 1], [1, 1, -1]],
                      [[-1, -1, -1], [-1, 1, -1], [1, 1, -1], [1, -1, -1]],
                      [[-1, -1, 1], [1, -1, 1], [1, 1, 1], [-1, 1, 1]]];

test('Self union', t => {
  const unionPolygons = toPolygons({}, union(fromPolygons({}, cubePolygons),
                                             fromPolygons({}, cubePolygons)));
  t.deepEqual(unionPolygons,
              [[[-1, -1, -1], [-1, -1, 1], [-1, 1, 1], [-1, 1, -1]],
               [[1, -1, -1], [1, 1, -1], [1, 1, 1], [1, -1, 1]],
               [[-1, -1, -1], [1, -1, -1], [1, -1, 1], [-1, -1, 1]],
               [[-1, 1, -1], [-1, 1, 1], [1, 1, 1], [1, 1, -1]],
               [[-1, -1, -1], [-1, 1, -1], [1, 1, -1], [1, -1, -1]],
               [[-1, -1, 1], [1, -1, 1], [1, 1, 1], [-1, 1, 1]]]);
});

test('Overlapping union', t => {
  const unionPolygons =
      toPolygons(
        {},
        union(transform(mat4.fromTranslation([0.5, 0.5, 0.5]),
                        fromPolygons({}, cubePolygons)),
              fromPolygons({}, cubePolygons)));
  t.deepEqual(unionPolygons,
              [[[-0.5, 1, 1.5], [-0.5, 1.5, 1.5], [-0.5, 1.5, -0.5], [-0.5, 1, -0.5]],
               [[-0.5, -0.5, 1], [-0.5, -0.5, 1.5], [-0.5, 1, 1.5], [-0.5, 1, 1]],
               [[-1, -1, -1], [-1, -1, 1], [-1, 1, 1], [-1, 1, -1]],
               [[-1, -1, -1], [-0.5, -1, -1], [-0.5, -1, 1], [-1, -1, 1]],
               [[-1, 1, -1], [-1, 1, 1], [-0.5, 1, 1], [-0.5, 1, -1]],
               [[-1, -1, -1], [-1, 1, -1], [-0.5, 1, -1], [-0.5, -1, -1]],
               [[-1, -1, 1], [-0.5, -1, 1], [-0.5, 1, 1], [-1, 1, 1]],
               [[1.5, -0.5, -0.5], [1.5, 1.5, -0.5], [1.5, 1.5, 1.5], [1.5, -0.5, 1.5]],
               [[1, -0.5, -0.5], [1.5, -0.5, -0.5], [1.5, -0.5, 1.5], [1, -0.5, 1.5]],
               [[1, -0.5, 1], [1, -0.5, 1.5], [-0.5, -0.5, 1.5], [-0.5, -0.5, 1]],
               [[1, -1, -1], [1, -0.5, -1], [1, -0.5, 1], [1, -1, 1]],
               [[-0.5, -1, -1], [1, -1, -1], [1, -1, 1], [-0.5, -1, 1]],
               [[1, -0.5, -1], [1, -1, -1], [-0.5, -1, -1], [-0.5, -0.5, -1]],
               [[-0.5, -1, 1], [1, -1, 1], [1, -0.5, 1], [-0.5, -0.5, 1]],
               [[1, 1.5, 1.5], [1.5, 1.5, 1.5], [1.5, 1.5, -0.5], [1, 1.5, -0.5]],
               [[-0.5, 1.5, -0.5], [-0.5, 1.5, 1.5], [1, 1.5, 1.5], [1, 1.5, -0.5]],
               [[1, 1.5, -0.5], [1.5, 1.5, -0.5], [1.5, -0.5, -0.5], [1, -0.5, -0.5]],
               [[-0.5, 1, -0.5], [-0.5, 1.5, -0.5], [1, 1.5, -0.5], [1, 1, -0.5]],
               [[1, -0.5, -1], [1, 1, -1], [1, 1, -0.5], [1, -0.5, -0.5]],
               [[1, 1, -0.5], [1, 1, -1], [-0.5, 1, -1], [-0.5, 1, -0.5]],
               [[-0.5, 1, -1], [1, 1, -1], [1, -0.5, -1], [-0.5, -0.5, -1]],
               [[1, -0.5, 1.5], [1.5, -0.5, 1.5], [1.5, 1.5, 1.5], [1, 1.5, 1.5]],
               [[1, 1, 1.5], [1, 1.5, 1.5], [-0.5, 1.5, 1.5], [-0.5, 1, 1.5]],
               [[-0.5, -0.5, 1.5], [1, -0.5, 1.5], [1, 1, 1.5], [-0.5, 1, 1.5]]]);
});
