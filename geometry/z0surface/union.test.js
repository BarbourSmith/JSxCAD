import { canonicalize, transform } from '@jsxcad/geometry-polygons';

import { degToRad } from '@jsxcad/math-utils';
import { fromZRotation } from '@jsxcad/math-mat4';
import test from 'ava';
import { union } from './union';

const rectangle = [[[0, 0, 0], [2, 0, 0], [2, 1, 0], [0, 1, 0]]];

test('union: Union of no geometries produces an empty geometry', t => {
  t.deepEqual(union(), []);
});

test('union: Union of one geometry produces that geometry', t => {
  const result = union(rectangle);
  t.deepEqual(result, rectangle);
});

test('union: Union of rectangle with itself produces itself', t => {
  const result = union(rectangle, rectangle);
  t.deepEqual(canonicalize(result),
              [[[0,0,0],[2,0,0],[2,1,0],[0,1,0]]]);
});

test('union: Union of rectangle with itself rotated 90 degrees produces L', t => {
  const result = union(rectangle, transform(fromZRotation(degToRad(90)), rectangle));
  t.deepEqual(canonicalize(result),
              [[[-1,0,0],[2,0,0],[2,1,0],[0,1,0],[0,2,0],[-1,2,0]]]);
});

test('Find minimal bad case', t => {
  const bad = [[[[7.46400869786827,7.464008697868271,0],[15.000000000000002,15,0],[9.750026667063718,15,0]]],[[[14.999999999999996,-14.999999999999998,7.105427357601002e-15],[15.000000000000002,15,0],[7.46400869786827,7.464008697868271,0],[0.6496261588434002,-14.999999999999995,5.329070518200751e-15]]],[[[0.6496261588434002,-14.999999999999995,5.329070518200751e-15],[4.619397662556432,-1.9134171618254485,3.552713678800501e-15],[-2.375526595990383,-14.999999999999995,5.329070518200751e-15]]],[[[-2.375526595990383,-14.999999999999995,5.329070518200751e-15],[4.157348061512726,-2.7778511650980073,3.552713678800501e-15],[-5.873110265642561,-14.999999999999993,5.329070518200751e-15]]],[[[-5.873110265642561,-14.999999999999993,5.329070518200751e-15],[3.535533905932737,-3.535533905932735,3.552713678800501e-15],[-10.433958448672064,-14.999999999999993,5.329070518200751e-15]]],[[[-15.000000000000004,-13.65980748253337,3.552713678800501e-15],[-15.000000000000004,-14.999999999999991,3.552713678800501e-15],[-12.120892418760533,-12.120892418760523,3.552713678800501e-15]]],[[[-10.433958448672064,-14.999999999999993,5.329070518200751e-15],[2.777851165098009,-4.157348061512724,5.329070518200751e-15],[-12.120892418760533,-12.120892418760523,3.552713678800501e-15],[-15.000000000000004,-14.999999999999991,3.552713678800501e-15]]],[[[-15.000000000000004,-9.750026667063693,1.7763568394002505e-15],[-15.000000000000004,-13.65980748253337,3.552713678800501e-15],[-12.120892418760533,-12.120892418760523,3.552713678800501e-15],[-7.4640086978682625,-7.464008697868254,1.7763568394002505e-15]]],[[[-12.120892418760533,-12.120892418760523,3.552713678800501e-15],[1.91341716182545,-4.6193976625564295,5.329070518200751e-15],[-7.4640086978682625,-7.464008697868254,1.7763568394002505e-15]]],[[[-7.4640086978682625,-7.464008697868254,1.7763568394002505e-15],[-5.546258813969944,-5.546258813969936,1.7763568394002505e-15],[-15.000000000000004,-6.477371050357458,1.7763568394002505e-15],[-15.000000000000004,-9.750026667063693,1.7763568394002505e-15]]],[[[-7.4640086978682625,-7.464008697868254,1.7763568394002505e-15],[0.9754516100806415,-4.903926402016149,5.329070518200751e-15],[-5.546258813969944,-5.546258813969936,1.7763568394002505e-15]]],[[[-15.000000000000004,-6.477371050357458,1.7763568394002505e-15],[-5.546258813969944,-5.546258813969936,1.7763568394002505e-15],[-4.551696977071651,-4.551696977071643,1.7763568394002505e-15],[-15.000000000000004,-3.5226289496425203,0]]],[[[-5.546258813969944,-5.546258813969936,1.7763568394002505e-15],[-9.18485099360515e-16,-4.9999999999999964,5.329070518200751e-15],[-4.551696977071651,-4.551696977071643,1.7763568394002505e-15]]],[[[-15.000000000000004,-3.5226289496425203,0],[-4.551696977071651,-4.551696977071643,1.7763568394002505e-15],[-3.989595767844148,-3.9895957678441403,1.7763568394002505e-15],[-15.000000000000004,-0.6496261588434109,0]]],[[[-4.551696977071651,-4.551696977071643,1.7763568394002505e-15],[-0.9754516100806433,-4.903926402016148,5.329070518200751e-15],[-3.989595767844148,-3.9895957678441403,1.7763568394002505e-15]]],[[[-15.000000000000004,-0.6496261588434109,0],[-3.989595767844148,-3.9895957678441403,1.7763568394002505e-15],[-3.676832517592384,-3.6768325175923766,0],[-15.000000000000002,2.3755265959903777,0]]],[[[-3.989595767844148,-3.9895957678441403,1.7763568394002505e-15],[-1.9134171618254516,-4.619397662556429,5.329070518200751e-15],[-3.676832517592384,-3.6768325175923766,0]]],[[[-15.000000000000002,2.3755265959903777,0],[-3.676832517592384,-3.6768325175923766,0],[-3.5355339059327386,-3.5355339059327338,3.552713678800501e-15],[-15,5.873110265642545,-1.7763568394002505e-15]]],[[[-3.676832517592384,-3.6768325175923766,0],[-2.777851165098011,-4.157348061512723,5.329070518200751e-15],[-3.5355339059327386,-3.5355339059327338,3.552713678800501e-15]]],[[[-15,5.873110265642545,-1.7763568394002505e-15],[-3.5355339059327386,-3.5355339059327338,3.552713678800501e-15],[-15,10.433958448672065,-1.7763568394002505e-15]]],[[[-15,10.433958448672065,-1.7763568394002505e-15],[-4.157348061512727,-2.7778511650980064,3.552713678800501e-15],[-13.659807482533342,15.000000000000004,-3.552713678800501e-15],[-14.999999999999998,15.000000000000004,-3.552713678800501e-15]]],[[[-13.659807482533342,15.000000000000004,-3.552713678800501e-15],[-4.619397662556434,-1.9134171618254447,3.552713678800501e-15],[-9.750026667063697,15.000000000000004,-3.552713678800501e-15]]],[[[-9.750026667063697,15.000000000000004,-3.552713678800501e-15],[-4.903926402016152,-0.9754516100806383,3.552713678800501e-15],[-6.477371050357451,15.000000000000004,-3.552713678800501e-15]]],[[[-6.477371050357451,15.000000000000004,-3.552713678800501e-15],[-5,4.14806959708674e-15,3.552713678800501e-15],[-3.5226289496425505,15.000000000000004,-3.552713678800501e-15]]],[[[-3.5226289496425505,15.000000000000004,-3.552713678800501e-15],[-4.903926402016152,0.9754516100806466,3.552713678800501e-15],[-0.649626158843418,15.000000000000004,-3.552713678800501e-15]]],[[[-0.649626158843418,15.000000000000004,-3.552713678800501e-15],[-4.619397662556434,1.913417161825453,3.552713678800501e-15],[2.3755265959903937,15.000000000000002,-1.7763568394002505e-15]]],[[[2.3755265959903937,15.000000000000002,-1.7763568394002505e-15],[-4.157348061512726,2.7778511650980144,3.552713678800501e-15],[5.87311026564257,15.000000000000002,-1.7763568394002505e-15]]],[[[5.87311026564257,15.000000000000002,-1.7763568394002505e-15],[-3.5355339059327373,3.5355339059327413,3.552713678800501e-15],[9.523324064572614,14.252661674770277,0],[9.750026667063718,15,0]]],[[[9.523324064572614,14.252661674770277,0],[-2.77785116509801,4.15734806151273,1.7763568394002505e-15],[8.248835116812213,10.05123467182958,0]]],[[[8.248835116812213,10.05123467182958,0],[-1.9134171618254485,4.6193976625564375,1.7763568394002505e-15],[7.46400869786827,7.464008697868271,0]]],[[[7.46400869786827,7.464008697868271,0],[-0.975451610080641,4.903926402016156,1.7763568394002505e-15],[5.546258813969943,5.546258813969946,0]]],[[[6.923410858095817,5.68189645143209,0],[7.46400869786827,7.464008697868271,0],[5.546258813969943,5.546258813969946,0]]],[[[5.546258813969943,5.546258813969946,0],[3.0616169978683807e-16,5.0000000000000036,1.7763568394002505e-15],[4.551696977071651,4.5516969770716535,0]]],[[[5.546258813969943,5.546258813969946,0],[4.551696977071651,4.5516969770716535,0],[6.521710424050589,4.357667588046214,0],[6.923410858095817,5.68189645143209,0]]],[[[4.551696977071651,4.5516969770716535,0],[0.9754516100806416,4.903926402016156,1.7763568394002505e-15],[3.9895957678441487,3.989595767844152,0]]],[[[6.521710424050589,4.357667588046214,0],[4.551696977071651,4.5516969770716535,0],[3.9895957678441487,3.989595767844152,0],[6.206096418239344,3.3172276463332517,1.7763568394002505e-15]]],[[[3.9895957678441487,3.989595767844152,0],[1.9134171618254492,4.6193976625564375,1.7763568394002505e-15],[3.6768325175923797,3.676832517592383,1.7763568394002505e-15]]],[[[6.206096418239344,3.3172276463332517,1.7763568394002505e-15],[3.9895957678441487,3.989595767844152,0],[3.6768325175923797,3.676832517592383,1.7763568394002505e-15],[5.94707869758158,2.4633606530384125,1.7763568394002505e-15]]],[[[3.6768325175923797,3.676832517592383,1.7763568394002505e-15],[2.7778511650980113,4.15734806151273,1.7763568394002505e-15],[3.5355339059327378,3.535533905932741,3.552713678800501e-15]]],[[[5.94707869758158,2.4633606530384125,1.7763568394002505e-15],[3.6768325175923797,3.676832517592383,1.7763568394002505e-15],[3.5355339059327378,3.535533905932741,3.552713678800501e-15],[5.726802232856199,1.7372064650120498,1.7763568394002505e-15]]],[[[5.726802232856199,1.7372064650120498,1.7763568394002505e-15],[3.5355339059327378,3.535533905932741,3.552713678800501e-15],[5.533728296728441,1.1007269959380572,1.7763568394002505e-15]]],[[[5.533728296728441,1.1007269959380572,1.7763568394002505e-15],[4.157348061512726,2.7778511650980144,3.552713678800501e-15],[5.3599663449061,0.5279106072569761,1.7763568394002505e-15]]],[[[5.3599663449061,0.5279106072569761,1.7763568394002505e-15],[4.619397662556434,1.9134171618254525,3.552713678800501e-15],[5.199826412953557,1.3153001482627503e-15,1.7763568394002505e-15]]],[[[5.199826412953557,1.3153001482627503e-15,1.7763568394002505e-15],[4.903926402016152,0.9754516100806447,3.552713678800501e-15],[5.048977895520796,-0.4972809184491409,1.7763568394002505e-15]]],[[[5.048977895520796,-0.4972809184491409,1.7763568394002505e-15],[5,3.5357461975130637e-15,3.552713678800501e-15],[4.903926402016151,-0.9754516100806401,3.552713678800501e-15]]]];
  const input = bad.slice();
  const necessary = [];

  while (input.length > 0) {
    try {
      union(...input.slice(1), ...necessary);
    } catch (e) {
      // Error occurs without this value; unnecessary.
      input.shift();
      continue;
    }
console.log(`QQ/necessary/add: ${JSON.stringify(input[0])}`);
    necessary.push(input.shift());
  }

  console.log(`QQ/necessary: ${JSON.stringify(necessary)}`);

  const minimal = [[[[-13.659807482533342,15.000000000000004,-3.552713678800501e-15],[-4.619397662556434,-1.9134171618254447,3.552713678800501e-15],[-9.750026667063697,15.000000000000004,-3.552713678800501e-15]]],
                   [[[-9.750026667063697,15.000000000000004,-3.552713678800501e-15],[-4.903926402016152,-0.9754516100806383,3.552713678800501e-15],[-6.477371050357451,15.000000000000004,-3.552713678800501e-15]]]];

  console.log(`QQ/minimal: ${JSON.stringify(minimal)}`);
  union(...minimal.map(canonicalize));

  t.is(1, 2);
});
