import { fromSolidToJunctions, junctionSelector } from './junction.js';

import clean from './clean.js';
/** @type {function():Normalizer} createNormalize3 */
import { createNormalize3 } from '@jsxcad/algorithm-quantize';
import { fromPolygonsToCleanSolid } from './cleanSolid.js';
import fromSurface from './fromSurface.js';
import merge from './merge.js';
import split from './split.js';
import test from 'ava';
import toPolygons from './toPolygons.js';

const solid = [
  [
    [
      [-0.010000000000000231, 0.5000000000000001, -0.010000000000000342],
      [-0.49999999999999994, 0.5000000000000001, -0.5],
      [-0.49999999999999994, 0.5000000000000001, 0.5],
      [-0.010000000000000231, 0.5000000000000001, 0.5],
    ],
    [
      [-0.49999999999999994, 0.5000000000000001, -0.5],
      [-0.010000000000000231, 0.5000000000000001, -0.010000000000000342],
      [-0.010000000000000231, 0.5000000000000001, -0.5],
    ],
    [
      [0.51, 0.5, 0.5],
      [0.5100000000000001, 0.5, 0.01000000000000012],
      [0.5000000000000001, 0.5, 1.0928757898653885e-16],
      [0.5000000000000001, 0.5, 0.5],
    ],
    [
      [0.5100000000000001, 0.5, -0.5],
      [0.5000000000000001, 0.5, -0.5],
      [0.5000000000000001, 0.5, 1.0928757898653885e-16],
      [0.5100000000000001, 0.5, 0.01000000000000012],
    ],
    [
      [1, 0.5, 0.5],
      [0.5100000000000001, 0.5, 0.01000000000000012],
      [0.51, 0.5, 0.5],
    ],
    [
      [0.5100000000000001, 0.5, 0.01000000000000012],
      [1, 0.5, 0.5],
      [1, 0.5, -0.5],
      [0.5100000000000001, 0.5, -0.5],
    ],
    [
      [-0.010000000000000231, 0.5000000000000001, 0.5],
      [5.551115123125783e-17, 0.5000000000000001, 0.5],
      [0, 0.5000000000000001, -1.1102230246251565e-16],
      [-0.010000000000000231, 0.5000000000000001, -0.010000000000000342],
    ],
    [
      [-0.010000000000000231, 0.5000000000000001, -0.5],
      [-0.010000000000000231, 0.5000000000000001, -0.010000000000000342],
      [0, 0.5000000000000001, -1.1102230246251565e-16],
      [5.551115123125783e-17, 0.5000000000000001, -0.5],
    ],
    [
      [5.551115123125783e-17, 0.5000000000000001, 0.5],
      [0.5000000000000001, 0.5, 0.5],
      [0, 0.5000000000000001, -1.1102230246251565e-16],
    ],
    [
      [0, 0.5000000000000001, -1.1102230246251565e-16],
      [0.5000000000000001, 0.5, 0.5],
      [0.5000000000000001, 0.5, 1.0928757898653885e-16],
      [0.5000000000000001, 0.5, -0.5],
      [5.551115123125783e-17, 0.5000000000000001, -0.5],
    ],
  ],
  [
    [
      [-0.49999999999999994, 0.5000000000000001, 0.5],
      [-0.010000000000000231, 0.010000000000000064, 0.5],
      [-0.010000000000000231, 0.5000000000000001, 0.5],
    ],
    [
      [-0.010000000000000231, 0.010000000000000064, 0.5],
      [-0.49999999999999994, 0.5000000000000001, 0.5],
      [-0.5000000000000002, -0.49999999999999994, 0.5],
      [-0.010000000000000231, -0.5000000000000001, 0.5],
    ],
    [
      [0.51, 0.5, 0.5],
      [0.5000000000000001, 0.5, 0.5],
      [0.49999999999999994, -1.1102230246251565e-16, 0.5],
      [0.51, -0.010000000000000231, 0.5],
    ],
    [
      [0.5100000000000001, -0.5000000000000001, 0.5],
      [0.51, -0.010000000000000231, 0.5],
      [0.49999999999999994, -1.1102230246251565e-16, 0.5],
      [0.4999999999999999, -0.5000000000000002, 0.5],
    ],
    [
      [0.51, -0.010000000000000231, 0.5],
      [0.9999999999999999, -0.5000000000000002, 0.5],
      [1, 0.5, 0.5],
      [0.51, 0.5, 0.5],
    ],
    [
      [0.9999999999999999, -0.5000000000000002, 0.5],
      [0.51, -0.010000000000000231, 0.5],
      [0.5100000000000001, -0.5000000000000001, 0.5],
    ],
    [
      [-0.010000000000000231, 0.5000000000000001, 0.5],
      [-0.010000000000000231, 0.010000000000000064, 0.5],
      [-8.153200337090993e-17, -8.673617379884035e-17, 0.5],
      [5.551115123125783e-17, 0.5000000000000001, 0.5],
    ],
    [
      [-0.010000000000000231, -0.5000000000000001, 0.5],
      [-2.220446049250313e-16, -0.49999999999999994, 0.5],
      [-8.153200337090993e-17, -8.673617379884035e-17, 0.5],
      [-0.010000000000000231, 0.010000000000000064, 0.5],
    ],
    [
      [-8.153200337090993e-17, -8.673617379884035e-17, 0.5],
      [0.4999999999999999, -0.5000000000000002, 0.5],
      [0.49999999999999994, -1.1102230246251565e-16, 0.5],
      [0.5000000000000001, 0.5, 0.5],
      [5.551115123125783e-17, 0.5000000000000001, 0.5],
    ],
    [
      [-2.220446049250313e-16, -0.49999999999999994, 0.5],
      [0.4999999999999999, -0.5000000000000002, 0.5],
      [-8.153200337090993e-17, -8.673617379884035e-17, 0.5],
    ],
  ],
  [
    [
      [-0.49999999999999994, 0.5000000000000001, 0.5],
      [-0.49999999999999994, 0.5000000000000001, -0.5],
      [-0.5000000000000002, -0.49999999999999994, -0.5],
    ],
    [
      [-0.5000000000000002, -0.49999999999999994, -0.5],
      [-0.5000000000000002, -0.49999999999999994, 0.5],
      [-0.49999999999999994, 0.5000000000000001, 0.5],
    ],
  ],
  [
    [
      [-0.010000000000000231, 0.010000000000000231, -0.5],
      [-0.49999999999999994, 0.5000000000000001, -0.5],
      [-0.010000000000000231, 0.5000000000000001, -0.5],
    ],
    [
      [-0.49999999999999994, 0.5000000000000001, -0.5],
      [-0.010000000000000231, 0.010000000000000231, -0.5],
      [-0.010000000000000231, -0.5000000000000001, -0.5],
      [-0.5000000000000002, -0.49999999999999994, -0.5],
    ],
    [
      [0.5100000000000001, 0.5, -0.5],
      [0.5100000000000001, -0.01000000000000012, -0.5],
      [0.5, 3.469446951953614e-18, -0.5],
      [0.5000000000000001, 0.5, -0.5],
    ],
    [
      [0.5, 3.469446951953614e-18, -0.5],
      [0.5100000000000001, -0.01000000000000012, -0.5],
      [0.5100000000000001, -0.5000000000000001, -0.5],
      [0.4999999999999999, -0.5000000000000002, -0.5],
    ],
    [
      [0.9999999999999999, -0.5000000000000002, -0.5],
      [0.5100000000000001, -0.01000000000000012, -0.5],
      [0.5100000000000001, 0.5, -0.5],
      [1, 0.5, -0.5],
    ],
    [
      [0.5100000000000001, -0.01000000000000012, -0.5],
      [0.9999999999999999, -0.5000000000000002, -0.5],
      [0.5100000000000001, -0.5000000000000001, -0.5],
    ],
    [
      [-1.1102230246251565e-16, 1.1102230246251565e-16, -0.5],
      [-0.010000000000000231, 0.010000000000000231, -0.5],
      [-0.010000000000000231, 0.5000000000000001, -0.5],
      [5.551115123125783e-17, 0.5000000000000001, -0.5],
    ],
    [
      [-0.010000000000000231, -0.5000000000000001, -0.5],
      [-0.010000000000000231, 0.010000000000000231, -0.5],
      [-1.1102230246251565e-16, 1.1102230246251565e-16, -0.5],
      [-2.220446049250313e-16, -0.49999999999999994, -0.5],
    ],
    [
      [0.5000000000000001, 0.5, -0.5],
      [0.5, 3.469446951953614e-18, -0.5],
      [0.4999999999999999, -0.5000000000000002, -0.5],
      [-1.1102230246251565e-16, 1.1102230246251565e-16, -0.5],
      [5.551115123125783e-17, 0.5000000000000001, -0.5],
    ],
    [
      [-1.1102230246251565e-16, 1.1102230246251565e-16, -0.5],
      [0.4999999999999999, -0.5000000000000002, -0.5],
      [-2.220446049250313e-16, -0.49999999999999994, -0.5],
    ],
  ],
  [
    [
      [-0.010000000000000231, -0.5000000000000001, 0.01000000000000012],
      [-0.5000000000000002, -0.49999999999999994, 0.5],
      [-0.5000000000000002, -0.49999999999999994, -0.5],
      [-0.010000000000000231, -0.5000000000000001, -0.5],
    ],
    [
      [-0.5000000000000002, -0.49999999999999994, 0.5],
      [-0.010000000000000231, -0.5000000000000001, 0.01000000000000012],
      [-0.010000000000000231, -0.5000000000000001, 0.5],
    ],
    [
      [0.5100000000000001, -0.5000000000000001, -0.5],
      [0.5100000000000001, -0.5000000000000001, -0.010000000000000231],
      [0.4999999999999999, -0.5000000000000001, -1.734723475976807e-18],
      [0.4999999999999999, -0.5000000000000002, -0.5],
    ],
    [
      [0.5100000000000001, -0.5000000000000001, 0.5],
      [0.4999999999999999, -0.5000000000000002, 0.5],
      [0.4999999999999999, -0.5000000000000001, -1.734723475976807e-18],
      [0.5100000000000001, -0.5000000000000001, -0.010000000000000231],
    ],
    [
      [0.9999999999999999, -0.5000000000000002, -0.5],
      [0.5100000000000001, -0.5000000000000001, -0.010000000000000231],
      [0.5100000000000001, -0.5000000000000001, -0.5],
    ],
    [
      [0.5100000000000001, -0.5000000000000001, -0.010000000000000231],
      [0.9999999999999999, -0.5000000000000002, -0.5],
      [0.9999999999999999, -0.5000000000000002, 0.5],
      [0.5100000000000001, -0.5000000000000001, 0.5],
    ],
    [
      [-0.010000000000000231, -0.5000000000000001, -0.5],
      [-2.220446049250313e-16, -0.49999999999999994, -0.5],
      [-2.220446049250313e-16, -0.5000000000000001, 1.1102230246251565e-16],
      [-0.010000000000000231, -0.5000000000000001, 0.01000000000000012],
    ],
    [
      [-0.010000000000000231, -0.5000000000000001, 0.5],
      [-0.010000000000000231, -0.5000000000000001, 0.01000000000000012],
      [-2.220446049250313e-16, -0.5000000000000001, 1.1102230246251565e-16],
      [-2.220446049250313e-16, -0.49999999999999994, 0.5],
    ],
    [
      [-2.220446049250313e-16, -0.49999999999999994, -0.5],
      [0.4999999999999999, -0.5000000000000002, -0.5],
      [-2.220446049250313e-16, -0.5000000000000001, 1.1102230246251565e-16],
    ],
    [
      [-2.220446049250313e-16, -0.5000000000000001, 1.1102230246251565e-16],
      [0.4999999999999999, -0.5000000000000002, -0.5],
      [0.4999999999999999, -0.5000000000000001, -1.734723475976807e-18],
      [0.4999999999999999, -0.5000000000000002, 0.5],
      [-2.220446049250313e-16, -0.49999999999999994, 0.5],
    ],
  ],
  [
    [
      [1, 0.5, -0.5],
      [1, 0.5, 0.5],
      [0.9999999999999999, -0.5000000000000002, 0.5],
    ],
    [
      [0.9999999999999999, -0.5000000000000002, 0.5],
      [0.9999999999999999, -0.5000000000000002, -0.5],
      [1, 0.5, -0.5],
    ],
  ],
];

test('merge/clean/split - left wall', (t) => {
  /** @type {Normalizer} */
  const normalize = createNormalize3();
  /** @type {Surface} */
  const surface = solid[2];
  const loops = fromSurface(surface, normalize);
  const mergedLoops = merge(loops);
  const cleanedLoops = mergedLoops.map(clean);
  const splitLoops = split(cleanedLoops);
  const polygons = toPolygons(splitLoops);
  t.deepEqual(polygons, [
    [
      [-0.5000000000000002, -0.49999999999999994, -0.5],
      [-0.5000000000000002, -0.49999999999999994, 0.5],
      [-0.49999999999999994, 0.5000000000000001, 0.5],
      [-0.49999999999999994, 0.5000000000000001, -0.5],
    ],
  ]);
});

test('merge/clean/split - front wall', (t) => {
  const normalize = createNormalize3();
  const selector = junctionSelector(
    fromSolidToJunctions(solid, normalize),
    normalize
  );
  const surface = solid[4];
  const loops = fromSurface(surface, normalize);
  const mergedLoops = merge(loops);
  const cleanedLoops = mergedLoops.map(clean);
  const splitLoops = split(cleanedLoops);
  const polygons = toPolygons(splitLoops);
  t.deepEqual(polygons, [
    [
      [-2.220446049250313e-16, -0.49999999999999994, 0.5],
      [-0.010000000000000231, -0.5000000000000001, 0.5],
      [-0.5000000000000002, -0.49999999999999994, 0.5],
      [-0.5000000000000002, -0.49999999999999994, -0.5],
      [-0.010000000000000231, -0.5000000000000001, -0.5],
      [-2.220446049250313e-16, -0.49999999999999994, -0.5],
      [0.4999999999999999, -0.5000000000000002, -0.5],
      [0.5100000000000001, -0.5000000000000001, -0.5],
      [0.9999999999999999, -0.5000000000000002, -0.5],
      [0.9999999999999999, -0.5000000000000002, 0.5],
      [0.5100000000000001, -0.5000000000000001, 0.5],
      [0.4999999999999999, -0.5000000000000002, 0.5],
    ],
  ]);
  const junctions = polygons[0].map(selector);
  t.deepEqual(junctions, [
    false,
    false,
    true,
    true,
    false,
    false,
    false,
    false,
    true,
    true,
    false,
    false,
  ]);
});

const canonicalize = (solid) => JSON.parse(JSON.stringify(solid));

const normalize = (normalizePoint, solid) =>
  solid.map((surface) =>
    surface.map((polygon) => polygon.map((point) => normalizePoint(point)))
  );

test('case #1', (t) => {
  const normalizer = createNormalize3();
  // const polygons = normalize(normalizer, [[[-0.009999999999998899, 5.000000000000001, -0.009999999999999787], [-5, 5.000000000000001, -5], [-5, 5.000000000000001, -0.009999999999999787]], [[-5, 5.000000000000001, -5], [-0.009999999999998899, 5.000000000000001, -0.009999999999999787], [5.000000000000001, 5, -0.009999999999999787], [5.000000000000001, 5, -5]], [[-5.000000000000002, -4.999999999999999, -5], [-5.000000000000001, -0.009999999999998899, -0.009999999999999787], [-5, 5.000000000000001, -0.009999999999999787], [-5, 5.000000000000001, -5]], [[-5.000000000000001, -0.009999999999998899, -0.009999999999999787], [-5.000000000000002, -4.999999999999999, -5], [-5.000000000000002, -4.999999999999999, -0.009999999999999787]], [[-5, 5.000000000000001, -5], [5.000000000000001, 5, -5], [4.999999999999999, -5.000000000000002, -5]], [[4.999999999999999, -5.000000000000002, -5], [-5.000000000000002, -4.999999999999999, -5], [-5, 5.000000000000001, -5]], [[5, 0.009999999999998899, -0.009999999999999787], [5.000000000000001, 5, -5], [5.000000000000001, 5, -0.009999999999999787]], [[5.000000000000001, 5, -5], [5, 0.009999999999998899, -0.009999999999999787], [4.999999999999999, -5.000000000000002, -0.009999999999999787], [4.999999999999999, -5.000000000000002, -5]], [[4.999999999999999, -5.000000000000002, -5], [0.009999999999998899, -5.000000000000001, -0.009999999999999787], [-5.000000000000002, -4.999999999999999, -0.009999999999999787], [-5.000000000000002, -4.999999999999999, -5]], [[0.009999999999998899, -5.000000000000001, -0.009999999999999787], [4.999999999999999, -5.000000000000002, -5], [4.999999999999999, -5.000000000000002, -0.009999999999999787]], [[-5, 5.000000000000001, 5], [-0.010000000000001563, 5.000000000000001, 5], [-0.009999999999998899, 5.000000000000001, -0.009999999999999787], [-5, 5.000000000000001, -0.009999999999999787]], [[-5, 5.000000000000001, 5], [-0.010000000000001563, 0.010000000000000675, 5], [-0.010000000000001563, 5.000000000000001, 5]], [[-0.010000000000001563, 0.010000000000000675, 5], [-5, 5.000000000000001, 5], [-5.000000000000002, -4.999999999999999, 5], [-0.010000000000001563, -5, 5]], [[-5.000000000000001, -0.009999999999998899, -0.009999999999999787], [-5, 5.000000000000001, 5], [-5, 5.000000000000001, -0.009999999999999787]], [[-5, 5.000000000000001, 5], [-5.000000000000001, -0.009999999999998899, -0.009999999999999787], [-5.000000000000002, -4.999999999999999, -0.009999999999999787], [-5.000000000000002, -4.999999999999999, 5]], [[-5.000000000000002, -4.999999999999999, -0.009999999999999787], [-0.010000000000001563, -5.000000000000001, -0.009999999999999787], [-0.010000000000001782, -5.000000000000001, 0.01000000000000089], [-5.000000000000002, -4.999999999999999, 5]], [[-0.010000000000001563, -5, 5], [-5.000000000000002, -4.999999999999999, 5], [-0.010000000000001782, -5.000000000000001, 0.01000000000000089]], [[0.010000000000000883, -0.010000000000001778, 5], [4.999999999999999, -5.000000000000002, 5], [5, -0.010000000000001563, 5]], [[-0.010000000000001563, -5, 5], [4.999999999999999, -5.000000000000002, 5], [0.010000000000000883, -0.010000000000001778, 5], [-0.010000000000001563, -0.010000000000001778, 5]], [[5, -0.010000000000001563, 5], [4.999999999999999, -5.000000000000002, 5], [5, -0.010000000000001563, 0.010000000000000675]], [[4.999999999999999, -5.000000000000002, -0.009999999999999787], [5, -0.010000000000001563, -0.009999999999999787], [5, -0.010000000000001563, 0.010000000000000675], [4.999999999999999, -5.000000000000002, 5]], [[-0.010000000000001563, -5.000000000000001, -0.009999999999999787], [0.009999999999998899, -5.000000000000001, -0.009999999999999787], [-0.010000000000001782, -5.000000000000001, 0.01000000000000089]], [[4.999999999999999, -5.000000000000002, 5], [-0.010000000000001563, -5, 5], [-0.010000000000001782, -5.000000000000001, 0.01000000000000089], [0.009999999999998899, -5.000000000000001, -0.009999999999999787], [4.999999999999999, -5.000000000000002, -0.009999999999999787]], [[-8.86402062860725e-16, 5.010000000000001, 5.01], [-8.86402062860725e-16, 5.010000000000001, 5], [-8.881784197001252e-16, 5.000000000000001, 5]], [[-1.7763568394002505e-15, 8.881784197001252e-16, 5.01], [-8.86402062860725e-16, 5.010000000000001, 5.01], [-8.881784197001252e-16, 5.000000000000001, 5], [-1.779826286352204e-15, 8.881784197001252e-16, 5]], [[-1.7763568394002505e-15, 8.881784197001252e-16, 5.01], [-1.779826286352204e-15, 8.881784197001252e-16, 5], [5, -4.440892098500626e-16, 5], [4.989999999999999, -4.4142467459096214e-16, 5.01]], [[5.010000000000001, -4.467537451091631e-16, 5], [5.010000000000001, -4.467537451091631e-16, 5.01], [4.989999999999999, -4.4142467459096214e-16, 5.01], [5, -4.440892098500626e-16, 5]], [[5.000000000000001, 5.010000000000001, 0], [5.010000000000001, 5.010000000000001, 0], [5.010000000000001, 4.989999999999998, 0], [5.000000000000001, 5, 0]], [[5.010000000000001, -4.467537451091635e-16, 0], [5, -8.881784197001252e-16, 0], [5.000000000000001, 5, 0], [5.010000000000001, 4.989999999999998, 0]], [[5, -4.440892098500626e-16, 5], [5, -8.881784197001252e-16, 0], [5.010000000000001, -4.467537451091635e-16, 0], [5.010000000000001, -4.467537451091631e-16, 4.989999999999998]], [[5.010000000000001, -4.467537451091631e-16, 4.989999999999998], [5.010000000000001, -4.467537451091631e-16, 5], [5, -4.440892098500626e-16, 5]], [[-8.881784197001252e-16, 5.000000000000001, 5], [-8.86402062860725e-16, 5.010000000000001, 5], [-8.864020628607249e-16, 5.010000000000001, 0], [8.881784197001252e-16, 5.000000000000001, 0]], [[4.989999999999998, 5.010000000000001, 0], [5.000000000000001, 5.010000000000001, 0], [5.000000000000001, 5, 0]], [[5.000000000000001, 5, 0], [8.881784197001252e-16, 5.000000000000001, 0], [-8.864020628607249e-16, 5.010000000000001, 0], [4.989999999999998, 5.010000000000001, 0]], [[10, 10, 10], [5.01, 10, 5.01], [0, 10, 5.01], [0, 10, 10]], [[5.01, 10, 5.01], [10, 10, 10], [10, 10, 5.01]], [[10, -1.7763568394002505e-15, 10], [10, 10, 10], [0, 10, 10]], [[0, 10, 10], [-1.7763568394002505e-15, 8.881784197001252e-16, 10], [10, -1.7763568394002505e-15, 10]], [[-8.86402062860725e-16, 5.010000000000001, 5.01], [0, 10, 10], [0, 10, 5.01]], [[0, 10, 10], [-8.86402062860725e-16, 5.010000000000001, 5.01], [-1.7763568394002505e-15, 8.881784197001252e-16, 5.01], [-1.7763568394002505e-15, 8.881784197001252e-16, 10]], [[10, -1.7763568394002505e-15, 10], [10, 4.989999999999999, 5.01], [10, 10, 5.01], [10, 10, 10]], [[10, 4.989999999999999, 5.01], [10, -1.7763568394002505e-15, 10], [10, -1.7763568394002505e-15, 5.01]], [[4.989999999999999, -4.4142467459096214e-16, 5.01], [-1.7763568394002505e-15, 8.881784197001252e-16, 10], [-1.7763568394002505e-15, 8.881784197001252e-16, 5.01]], [[-1.7763568394002505e-15, 8.881784197001252e-16, 10], [4.989999999999999, -4.4142467459096214e-16, 5.01], [10, -1.7763568394002505e-15, 5.01], [10, -1.7763568394002505e-15, 10]], [[10, 10, 0], [5.010000000000001, 10, 0], [5.01, 10, 5.01], [10, 10, 5.01]], [[10, -1.7763568394002505e-15, 0], [5.010000000000001, 4.989999999999998, 0], [5.010000000000001, 10, 0], [10, 10, 0]], [[5.010000000000001, 4.989999999999998, 0], [10, -1.7763568394002505e-15, 0], [5.010000000000001, -4.467537451091635e-16, 0]], [[10, 4.989999999999999, 5.01], [10, 10, 0], [10, 10, 5.01]], [[10, 10, 0], [10, 4.989999999999999, 5.01], [10, -1.7763568394002505e-15, 5.01], [10, -1.7763568394002505e-15, 0]], [[5.010000000000001, -4.467537451091635e-16, 0], [10, -1.7763568394002505e-15, 0], [5.010000000000001, -4.467537451091631e-16, 4.989999999999998]], [[10, -1.7763568394002505e-15, 5.01], [5.010000000000001, -4.467537451091631e-16, 5.01], [5.010000000000001, -4.467537451091631e-16, 4.989999999999998], [10, -1.7763568394002505e-15, 0]], [[5.01, 10, 5.01], [0, 10, 0], [0, 10, 5.01]], [[5.010000000000001, 10, 0], [0, 10, 0], [5.01, 10, 5.01]], [[0, 10, 0], [-8.864020628607249e-16, 5.010000000000001, 0], [-8.86402062860725e-16, 5.010000000000001, 5.01], [0, 10, 5.01]], [[5.010000000000001, 10, 0], [5.010000000000001, 5.010000000000001, 0], [4.989999999999998, 5.010000000000001, 0], [0, 10, 0]], [[-8.864020628607249e-16, 5.010000000000001, 0], [0, 10, 0], [4.989999999999998, 5.010000000000001, 0]], [[-0.009999999999998899, 5.000000000000001, -0.009999999999999787], [-0.009999999999998904, 5.000000000000001, -1.734723475976807e-18], [8.881784197001252e-16, 5.000000000000001, 0]], [[5.000000000000001, 5, -0.009999999999999787], [-0.009999999999998899, 5.000000000000001, -0.009999999999999787], [8.881784197001252e-16, 5.000000000000001, 0], [5.000000000000001, 5, 0]], [[5.000000000000001, 5, -0.009999999999999787], [5.000000000000001, 5, 0], [5, -8.881784197001252e-16, 0], [5, 0.009999999999998899, -0.009999999999999787]], [[5, -0.010000000000001563, 0], [5, -0.010000000000001563, -0.009999999999999787], [5, 0.009999999999998899, -0.009999999999999787], [5, -8.881784197001252e-16, 0]], [[-1.779826286352204e-15, 8.881784197001252e-16, 5], [0.010000000000000883, -0.010000000000001778, 5], [5, -0.010000000000001563, 5], [5, -4.440892098500626e-16, 5]], [[-0.010000000000001563, -0.010000000000001778, 5], [0.010000000000000883, -0.010000000000001778, 5], [-1.779826286352204e-15, 8.881784197001252e-16, 5], [-0.010000000000001563, 8.916478666520788e-16, 5]], [[5, -8.881784197001252e-16, 0], [5, -4.440892098500626e-16, 5], [5, -0.010000000000001563, 5], [5, -0.010000000000001563, 0.010000000000000675]], [[5, -0.010000000000001563, 0.010000000000000675], [5, -0.010000000000001563, 0], [5, -8.881784197001252e-16, 0]], [[8.881784197001252e-16, 5.000000000000001, 0], [-0.009999999999998904, 5.000000000000001, -1.734723475976807e-18], [-0.010000000000001563, 5.000000000000001, 5], [-8.881784197001252e-16, 5.000000000000001, 5]], [[-8.881784197001252e-16, 5.000000000000001, 5], [-0.010000000000001563, 5.000000000000001, 5], [-0.010000000000001563, 0.010000000000000675, 5], [-1.779826286352204e-15, 8.881784197001252e-16, 5]], [[-1.779826286352204e-15, 8.881784197001252e-16, 5], [-0.010000000000001563, 0.010000000000000675, 5], [-0.010000000000001563, 8.916478666520788e-16, 5]]]);
  const polygons = normalize(normalizer, [
    [
      [-0.009999999999998899, 5.000000000000001, -0.009999999999999787],
      [-5, 5.000000000000001, -5],
      [-5, 5.000000000000001, -0.009999999999999787],
    ],
    [
      [-5, 5.000000000000001, -5],
      [-0.009999999999998899, 5.000000000000001, -0.009999999999999787],
      [5.000000000000001, 5, -0.009999999999999787],
      [5.000000000000001, 5, -5],
    ],
    [
      [-5.000000000000002, -4.999999999999999, -5],
      [-5.000000000000001, -0.009999999999998899, -0.009999999999999787],
      [-5, 5.000000000000001, -0.009999999999999787],
      [-5, 5.000000000000001, -5],
    ],
    [
      [-5.000000000000001, -0.009999999999998899, -0.009999999999999787],
      [-5.000000000000002, -4.999999999999999, -5],
      [-5.000000000000002, -4.999999999999999, -0.009999999999999787],
    ],
    [
      [-5, 5.000000000000001, -5],
      [5.000000000000001, 5, -5],
      [4.999999999999999, -5.000000000000002, -5],
    ],
    [
      [4.999999999999999, -5.000000000000002, -5],
      [-5.000000000000002, -4.999999999999999, -5],
      [-5, 5.000000000000001, -5],
    ],
    [
      [5, 0.009999999999998899, -0.009999999999999787],
      [5.000000000000001, 5, -5],
      [5.000000000000001, 5, -0.009999999999999787],
    ],
    [
      [5.000000000000001, 5, -5],
      [5, 0.009999999999998899, -0.009999999999999787],
      [4.999999999999999, -5.000000000000002, -0.009999999999999787],
      [4.999999999999999, -5.000000000000002, -5],
    ],
    [
      [4.999999999999999, -5.000000000000002, -5],
      [0.009999999999998899, -5.000000000000001, -0.009999999999999787],
      [-5.000000000000002, -4.999999999999999, -0.009999999999999787],
      [-5.000000000000002, -4.999999999999999, -5],
    ],
    [
      [0.009999999999998899, -5.000000000000001, -0.009999999999999787],
      [4.999999999999999, -5.000000000000002, -5],
      [4.999999999999999, -5.000000000000002, -0.009999999999999787],
    ],
    [
      [-5, 5.000000000000001, 5],
      [-0.010000000000001563, 5.000000000000001, 5],
      [-0.009999999999998899, 5.000000000000001, -0.009999999999999787],
      [-5, 5.000000000000001, -0.009999999999999787],
    ],
    [
      [-5, 5.000000000000001, 5],
      [-0.010000000000001563, 0.010000000000000675, 5],
      [-0.010000000000001563, 5.000000000000001, 5],
    ],
    [
      [-0.010000000000001563, 0.010000000000000675, 5],
      [-5, 5.000000000000001, 5],
      [-5.000000000000002, -4.999999999999999, 5],
      [-0.010000000000001563, -5, 5],
    ],
    [
      [-5.000000000000001, -0.009999999999998899, -0.009999999999999787],
      [-5, 5.000000000000001, 5],
      [-5, 5.000000000000001, -0.009999999999999787],
    ],
    [
      [-5, 5.000000000000001, 5],
      [-5.000000000000001, -0.009999999999998899, -0.009999999999999787],
      [-5.000000000000002, -4.999999999999999, -0.009999999999999787],
      [-5.000000000000002, -4.999999999999999, 5],
    ],
    [
      [-5.000000000000002, -4.999999999999999, -0.009999999999999787],
      [-0.010000000000001563, -5.000000000000001, -0.009999999999999787],
      [-0.010000000000001782, -5.000000000000001, 0.01000000000000089],
      [-5.000000000000002, -4.999999999999999, 5],
    ],
    [
      [-0.010000000000001563, -5, 5],
      [-5.000000000000002, -4.999999999999999, 5],
      [-0.010000000000001782, -5.000000000000001, 0.01000000000000089],
    ],
    [
      [0.010000000000000883, -0.010000000000001778, 5],
      [4.999999999999999, -5.000000000000002, 5],
      [5, -0.010000000000001563, 5],
    ],
    [
      [-0.010000000000001563, -5, 5],
      [4.999999999999999, -5.000000000000002, 5],
      [0.010000000000000883, -0.010000000000001778, 5],
      [-0.010000000000001563, -0.010000000000001778, 5],
    ],
    [
      [5, -0.010000000000001563, 5],
      [4.999999999999999, -5.000000000000002, 5],
      [5, -0.010000000000001563, 0.010000000000000675],
    ],
    [
      [4.999999999999999, -5.000000000000002, -0.009999999999999787],
      [5, -0.010000000000001563, -0.009999999999999787],
      [5, -0.010000000000001563, 0.010000000000000675],
      [4.999999999999999, -5.000000000000002, 5],
    ],
    [
      [-0.010000000000001563, -5.000000000000001, -0.009999999999999787],
      [0.009999999999998899, -5.000000000000001, -0.009999999999999787],
      [-0.010000000000001782, -5.000000000000001, 0.01000000000000089],
    ],
    [
      [4.999999999999999, -5.000000000000002, 5],
      [-0.010000000000001563, -5, 5],
      [-0.010000000000001782, -5.000000000000001, 0.01000000000000089],
      [0.009999999999998899, -5.000000000000001, -0.009999999999999787],
      [4.999999999999999, -5.000000000000002, -0.009999999999999787],
    ],
    [
      [-8.86402062860725e-16, 5.010000000000001, 5.01],
      [-8.86402062860725e-16, 5.010000000000001, 5],
      [-8.881784197001252e-16, 5.000000000000001, 5],
    ],
    [
      [-1.7763568394002505e-15, 8.881784197001252e-16, 5.01],
      [-8.86402062860725e-16, 5.010000000000001, 5.01],
      [-8.881784197001252e-16, 5.000000000000001, 5],
      [-1.779826286352204e-15, 8.881784197001252e-16, 5],
    ],
    [
      [-1.7763568394002505e-15, 8.881784197001252e-16, 5.01],
      [-1.779826286352204e-15, 8.881784197001252e-16, 5],
      [5, -4.440892098500626e-16, 5],
      [4.989999999999999, -4.4142467459096214e-16, 5.01],
    ],
    [
      [5.010000000000001, -4.467537451091631e-16, 5],
      [5.010000000000001, -4.467537451091631e-16, 5.01],
      [4.989999999999999, -4.4142467459096214e-16, 5.01],
      [5, -4.440892098500626e-16, 5],
    ],
    [
      [5.000000000000001, 5.010000000000001, 0],
      [5.010000000000001, 5.010000000000001, 0],
      [5.010000000000001, 4.989999999999998, 0],
      [5.000000000000001, 5, 0],
    ],
    [
      [5.010000000000001, -4.467537451091635e-16, 0],
      [5, -8.881784197001252e-16, 0],
      [5.000000000000001, 5, 0],
      [5.010000000000001, 4.989999999999998, 0],
    ],
    [
      [5, -4.440892098500626e-16, 5],
      [5, -8.881784197001252e-16, 0],
      [5.010000000000001, -4.467537451091635e-16, 0],
      [5.010000000000001, -4.467537451091631e-16, 4.989999999999998],
    ],
    [
      [5.010000000000001, -4.467537451091631e-16, 4.989999999999998],
      [5.010000000000001, -4.467537451091631e-16, 5],
      [5, -4.440892098500626e-16, 5],
    ],
    [
      [-8.881784197001252e-16, 5.000000000000001, 5],
      [-8.86402062860725e-16, 5.010000000000001, 5],
      [-8.864020628607249e-16, 5.010000000000001, 0],
      [8.881784197001252e-16, 5.000000000000001, 0],
    ],
    [
      [4.989999999999998, 5.010000000000001, 0],
      [5.000000000000001, 5.010000000000001, 0],
      [5.000000000000001, 5, 0],
    ],
    [
      [5.000000000000001, 5, 0],
      [8.881784197001252e-16, 5.000000000000001, 0],
      [-8.864020628607249e-16, 5.010000000000001, 0],
      [4.989999999999998, 5.010000000000001, 0],
    ],
    [
      [10, 10, 10],
      [5.01, 10, 5.01],
      [0, 10, 5.01],
      [0, 10, 10],
    ],
    [
      [5.01, 10, 5.01],
      [10, 10, 10],
      [10, 10, 5.01],
    ],
    [
      [10, -1.7763568394002505e-15, 10],
      [10, 10, 10],
      [0, 10, 10],
    ],
    [
      [0, 10, 10],
      [-1.7763568394002505e-15, 8.881784197001252e-16, 10],
      [10, -1.7763568394002505e-15, 10],
    ],
    [
      [-8.86402062860725e-16, 5.010000000000001, 5.01],
      [0, 10, 10],
      [0, 10, 5.01],
    ],
    [
      [0, 10, 10],
      [-8.86402062860725e-16, 5.010000000000001, 5.01],
      [-1.7763568394002505e-15, 8.881784197001252e-16, 5.01],
      [-1.7763568394002505e-15, 8.881784197001252e-16, 10],
    ],
    [
      [10, -1.7763568394002505e-15, 10],
      [10, 4.989999999999999, 5.01],
      [10, 10, 5.01],
      [10, 10, 10],
    ],
    [
      [10, 4.989999999999999, 5.01],
      [10, -1.7763568394002505e-15, 10],
      [10, -1.7763568394002505e-15, 5.01],
    ],
    [
      [4.989999999999999, -4.4142467459096214e-16, 5.01],
      [-1.7763568394002505e-15, 8.881784197001252e-16, 10],
      [-1.7763568394002505e-15, 8.881784197001252e-16, 5.01],
    ],
    [
      [-1.7763568394002505e-15, 8.881784197001252e-16, 10],
      [4.989999999999999, -4.4142467459096214e-16, 5.01],
      [10, -1.7763568394002505e-15, 5.01],
      [10, -1.7763568394002505e-15, 10],
    ],
    [
      [10, 10, 0],
      [5.010000000000001, 10, 0],
      [5.01, 10, 5.01],
      [10, 10, 5.01],
    ],
    [
      [10, -1.7763568394002505e-15, 0],
      [5.010000000000001, 4.989999999999998, 0],
      [5.010000000000001, 10, 0],
      [10, 10, 0],
    ],
    [
      [5.010000000000001, 4.989999999999998, 0],
      [10, -1.7763568394002505e-15, 0],
      [5.010000000000001, -4.467537451091635e-16, 0],
    ],
    [
      [10, 4.989999999999999, 5.01],
      [10, 10, 0],
      [10, 10, 5.01],
    ],
    [
      [10, 10, 0],
      [10, 4.989999999999999, 5.01],
      [10, -1.7763568394002505e-15, 5.01],
      [10, -1.7763568394002505e-15, 0],
    ],
    [
      [5.010000000000001, -4.467537451091635e-16, 0],
      [10, -1.7763568394002505e-15, 0],
      [5.010000000000001, -4.467537451091631e-16, 4.989999999999998],
    ],
    [
      [10, -1.7763568394002505e-15, 5.01],
      [5.010000000000001, -4.467537451091631e-16, 5.01],
      [5.010000000000001, -4.467537451091631e-16, 4.989999999999998],
      [10, -1.7763568394002505e-15, 0],
    ],
    [
      [5.01, 10, 5.01],
      [0, 10, 0],
      [0, 10, 5.01],
    ],
    [
      [5.010000000000001, 10, 0],
      [0, 10, 0],
      [5.01, 10, 5.01],
    ],
    [
      [0, 10, 0],
      [-8.864020628607249e-16, 5.010000000000001, 0],
      [-8.86402062860725e-16, 5.010000000000001, 5.01],
      [0, 10, 5.01],
    ],
    [
      [5.010000000000001, 10, 0],
      [5.010000000000001, 5.010000000000001, 0],
      [4.989999999999998, 5.010000000000001, 0],
      [0, 10, 0],
    ],
    [
      [-8.864020628607249e-16, 5.010000000000001, 0],
      [0, 10, 0],
      [4.989999999999998, 5.010000000000001, 0],
    ],
    [
      [-0.009999999999998899, 5.000000000000001, -0.009999999999999787],
      [-0.009999999999998904, 5.000000000000001, -1.734723475976807e-18],
      [8.881784197001252e-16, 5.000000000000001, 0],
    ],
    [
      [5.000000000000001, 5, -0.009999999999999787],
      [-0.009999999999998899, 5.000000000000001, -0.009999999999999787],
      [8.881784197001252e-16, 5.000000000000001, 0],
      [5.000000000000001, 5, 0],
    ],
    [
      [5.000000000000001, 5, -0.009999999999999787],
      [5.000000000000001, 5, 0],
      [5, -8.881784197001252e-16, 0],
      [5, 0.009999999999998899, -0.009999999999999787],
    ],
    [
      [5, -0.010000000000001563, 0],
      [5, -0.010000000000001563, -0.009999999999999787],
      [5, 0.009999999999998899, -0.009999999999999787],
      [5, -8.881784197001252e-16, 0],
    ],
    [
      [-1.779826286352204e-15, 8.881784197001252e-16, 5],
      [0.010000000000000883, -0.010000000000001778, 5],
      [5, -0.010000000000001563, 5],
      [5, -4.440892098500626e-16, 5],
    ],
    [
      [-0.010000000000001563, -0.010000000000001778, 5],
      [0.010000000000000883, -0.010000000000001778, 5],
      [-1.779826286352204e-15, 8.881784197001252e-16, 5],
      [-0.010000000000001563, 8.916478666520788e-16, 5],
    ],
    [
      [5, -8.881784197001252e-16, 0],
      [5, -4.440892098500626e-16, 5],
      [5, -0.010000000000001563, 5],
      [5, -0.010000000000001563, 0.010000000000000675],
    ],
    [
      [5, -0.010000000000001563, 0.010000000000000675],
      [5, -0.010000000000001563, 0],
      [5, -8.881784197001252e-16, 0],
    ],
    [
      [8.881784197001252e-16, 5.000000000000001, 0],
      [-0.009999999999998904, 5.000000000000001, -1.734723475976807e-18],
      [-0.010000000000001563, 5.000000000000001, 5],
      [-8.881784197001252e-16, 5.000000000000001, 5],
    ],
    [
      [-8.881784197001252e-16, 5.000000000000001, 5],
      [-0.010000000000001563, 5.000000000000001, 5],
      [-0.010000000000001563, 0.010000000000000675, 5],
      [-1.779826286352204e-15, 8.881784197001252e-16, 5],
    ],
    [
      [-1.779826286352204e-15, 8.881784197001252e-16, 5],
      [-0.010000000000001563, 0.010000000000000675, 5],
      [-0.010000000000001563, 8.916478666520788e-16, 5],
    ],
  ]);
  const cleanedSolid = fromPolygonsToCleanSolid(polygons, normalizer);
  console.log(`QQ/cleanedSolid: ${JSON.stringify(cleanedSolid)}`);
  t.deepEqual(canonicalize(cleanedSolid), [
    [
      [
        [-1.7763568394002505e-15, 8.881784197001252e-16, 10],
        [10, -1.7763568394002505e-15, 10],
        [10, 10, 10],
      ],
      [
        [10, 10, 10],
        [0, 10, 10],
        [-1.7763568394002505e-15, 8.881784197001252e-16, 10],
      ],
    ],
    [
      [
        [10, 10, 10],
        [10, 10, 0],
        [0, 10, 0],
      ],
      [
        [0, 10, 0],
        [0, 10, 10],
        [10, 10, 10],
      ],
    ],
    [
      [
        [10, 10, 10],
        [10, -1.7763568394002505e-15, 10],
        [10, -1.7763568394002505e-15, 0],
      ],
      [
        [10, -1.7763568394002505e-15, 0],
        [10, 10, 0],
        [10, 10, 10],
      ],
    ],
    [
      [
        [10, -1.7763568394002505e-15, 10],
        [-1.7763568394002505e-15, 8.881784197001252e-16, 10],
        [-1.779826286352204e-15, 8.881784197001252e-16, 5],
      ],
      [
        [5, -4.440892098500626e-16, 5],
        [5, -8.881784197001252e-16, 0],
        [10, -1.7763568394002505e-15, 0],
      ],
      [
        [10, -1.7763568394002505e-15, 10],
        [-1.779826286352204e-15, 8.881784197001252e-16, 5],
        [5, -4.440892098500626e-16, 5],
      ],
      [
        [5, -4.440892098500626e-16, 5],
        [10, -1.7763568394002505e-15, 0],
        [10, -1.7763568394002505e-15, 10],
      ],
    ],
    [
      [
        [0, 10, 0],
        [8.881784197001252e-16, 5.000000000000001, 0],
        [-8.881784197001252e-16, 5.000000000000001, 5],
      ],
      [
        [-1.779826286352204e-15, 8.881784197001252e-16, 5],
        [-1.7763568394002505e-15, 8.881784197001252e-16, 10],
        [0, 10, 10],
      ],
      [
        [0, 10, 10],
        [0, 10, 0],
        [-8.881784197001252e-16, 5.000000000000001, 5],
      ],
      [
        [-8.881784197001252e-16, 5.000000000000001, 5],
        [-1.779826286352204e-15, 8.881784197001252e-16, 5],
        [0, 10, 10],
      ],
    ],
    [
      [
        [10, -1.7763568394002505e-15, 0],
        [5, -8.881784197001252e-16, 0],
        [5.000000000000001, 5, 0],
      ],
      [
        [8.881784197001252e-16, 5.000000000000001, 0],
        [0, 10, 0],
        [10, 10, 0],
      ],
      [
        [10, 10, 0],
        [10, -1.7763568394002505e-15, 0],
        [5.000000000000001, 5, 0],
      ],
      [
        [5.000000000000001, 5, 0],
        [8.881784197001252e-16, 5.000000000000001, 0],
        [10, 10, 0],
      ],
    ],
    [
      [
        [-5.000000000000002, -4.999999999999999, -5],
        [4.999999999999999, -5.000000000000002, -5],
        [4.999999999999999, -5.000000000000002, 5],
      ],
      [
        [4.999999999999999, -5.000000000000002, 5],
        [-5.000000000000002, -4.999999999999999, 5],
        [-5.000000000000002, -4.999999999999999, -5],
      ],
    ],
    [
      [
        [5, -4.440892098500626e-16, 5],
        [4.999999999999999, -5.000000000000002, 5],
        [4.999999999999999, -5.000000000000002, -5],
      ],
      [
        [4.999999999999999, -5.000000000000002, -5],
        [5.000000000000001, 5, -5],
        [5.000000000000001, 5, 0],
      ],
      [
        [5, -8.881784197001252e-16, 0],
        [5, -4.440892098500626e-16, 5],
        [4.999999999999999, -5.000000000000002, -5],
      ],
      [
        [4.999999999999999, -5.000000000000002, -5],
        [5.000000000000001, 5, 0],
        [5, -8.881784197001252e-16, 0],
      ],
    ],
    [
      [
        [4.999999999999999, -5.000000000000002, -5],
        [-5.000000000000002, -4.999999999999999, -5],
        [-5, 5.000000000000001, -5],
      ],
      [
        [-5, 5.000000000000001, -5],
        [5.000000000000001, 5, -5],
        [4.999999999999999, -5.000000000000002, -5],
      ],
    ],
    [
      [
        [-5.000000000000002, -4.999999999999999, -5],
        [-5.000000000000002, -4.999999999999999, 5],
        [-5, 5.000000000000001, 5],
      ],
      [
        [-5, 5.000000000000001, 5],
        [-5, 5.000000000000001, -5],
        [-5.000000000000002, -4.999999999999999, -5],
      ],
    ],
    [
      [
        [-1.779826286352204e-15, 8.881784197001252e-16, 5],
        [-8.881784197001252e-16, 5.000000000000001, 5],
        [-5, 5.000000000000001, 5],
      ],
      [
        [-5.000000000000002, -4.999999999999999, 5],
        [4.999999999999999, -5.000000000000002, 5],
        [5, -4.440892098500626e-16, 5],
      ],
      [
        [-1.779826286352204e-15, 8.881784197001252e-16, 5],
        [-5, 5.000000000000001, 5],
        [-5.000000000000002, -4.999999999999999, 5],
      ],
      [
        [-5.000000000000002, -4.999999999999999, 5],
        [5, -4.440892098500626e-16, 5],
        [-1.779826286352204e-15, 8.881784197001252e-16, 5],
      ],
    ],
    [
      [
        [-5, 5.000000000000001, 5],
        [-8.881784197001252e-16, 5.000000000000001, 5],
        [8.881784197001252e-16, 5.000000000000001, 0],
      ],
      [
        [5.000000000000001, 5, -5],
        [-5, 5.000000000000001, -5],
        [-5, 5.000000000000001, 5],
      ],
      [
        [8.881784197001252e-16, 5.000000000000001, 0],
        [5.000000000000001, 5, 0],
        [5.000000000000001, 5, -5],
      ],
      [
        [5.000000000000001, 5, -5],
        [-5, 5.000000000000001, 5],
        [8.881784197001252e-16, 5.000000000000001, 0],
      ],
    ],
  ]);
});
